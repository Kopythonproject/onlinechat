<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>DrawTogether - ìŒì„±/ì˜ìƒ ì±„íŒ… (í˜¸ìŠ¤íŠ¸ ê´€ë¦¬ í¬í•¨)</title>
<style>
  body { background: #121212; color: white; font-family: 'Noto Sans KR', sans-serif; margin: 0; padding: 20px; }
  h1 { text-align:center; }
  #videoContainer {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    max-width: 960px;
    margin: 0 auto 20px auto;
    background: #222;
    border-radius: 12px;
    padding: 10px;
    min-height: 120px;
  }
  .userBox {
    background: #333;
    padding: 10px;
    border-radius: 8px;
    width: 140px;
    position: relative;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .userBox.host {
    border: 2px solid gold;
  }
  .userName {
    font-weight: 700;
    margin-bottom: 6px;
  }
  video {
    width: 120px;
    height: 90px;
    background: black;
    border-radius: 6px;
    object-fit: cover;
  }
  .controls {
    margin-top: 6px;
    display: flex;
    gap: 6px;
  }
  button.controlBtn {
    background: #555;
    border: none;
    color: white;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
  }
  button.controlBtn:hover {
    background: #00ff7f;
    color: black;
  }
  #localControls {
    text-align: center;
  }
  #localControls button {
    margin: 5px;
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    background: #444;
    color: white;
    cursor: pointer;
  }
  #localControls button:hover {
    background: #00ff7f;
    color: black;
  }
  /* ì˜ˆì‹œ ìŠ¤íƒ€ì¼ */
#chatContainer {
  position: fixed;
  bottom: 10px;
  right: 10px;
  width: 320px;
  max-height: 60vh;
  background: #222;
  border-radius: 12px;
  padding: 10px;
  display: flex;
  flex-direction: column;
}
#chatMessages {
  flex: 1;
  overflow-y: auto;
  margin-bottom: 10px;
  max-height: 300px;
  color: white;
}
#chatControls {
  display: flex;
  gap: 6px;
}
/* ğŸ“± ë°˜ì‘í˜• ëŒ€ì‘ */
@media (max-width: 600px) {
  #videoContainer {
    flex-direction: column;
    align-items: center;
  }
  .userBox {
    width: 90%;
  }
  #chatContainer {
    width: 90%;
    right: 5%;
    bottom: 20px;
  }
}

</style>
</head>
<body>

<h1>DrawTogether ìŒì„±/ì˜ìƒ ì±„íŒ…</h1>

<div id="videoContainer">
  <!-- ì‚¬ìš©ìë³„ ë¹„ë””ì˜¤ ë°•ìŠ¤ë“¤ ì—¬ê¸°ì— ë Œë”ë§ -->
</div>

<!-- ì±„íŒ… UI -->
<div id="chatContainer">
  <div id="chatMessages"></div>
  <div id="chatControls">
    <input id="chatInput" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
    <button id="sendMessage">ì „ì†¡</button>
    <button id="toggleMode">ğŸ’¬ í…ìŠ¤íŠ¸</button>
  </div>
</div>

<div id="localControls">
  <button id="toggleMic">ğŸ¤ ë§ˆì´í¬ ì¼œê¸°</button>
  <button id="toggleCam">ğŸ“· ì¹´ë©”ë¼ ì¼œê¸°</button>
  <button id="shareScreen">ğŸ–¥ï¸ í™”ë©´ ê³µìœ </button>
</div>
<div id="hostControls" style="text-align:center; margin-top:20px; display:none;">
  <button id="deleteRoomBtn" style="padding:10px 20px; background:red; color:white; border:none; border-radius:8px; cursor:pointer;">
    ğŸ§¨ ë°© ì—†ì• ê¸°
  </button>
</div>

<div id="bigScreenContainer" style="position: fixed; bottom: 60px; left: 10px; right: 10px; height: 250px; background: #111; border-radius: 12px; display: flex; justify-content: center; align-items: center; overflow: hidden;">
  <video id="bigScreenVideo" autoplay playsinline style="max-width: 100%; max-height: 100%; background: black; border-radius: 8px;"></video>
  <button id="expandBigScreenBtn" style="position: absolute; top: 10px; right: 10px; z-index: 10;">í™•ì¥</button>
</div>


<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDwTegUMVEfiLymObTxz4Camhtb84RkUtw",
    authDomain: "draw-f2d10.firebaseapp.com",
    databaseURL: "https://draw-f2d10-default-rtdb.firebaseio.com",
    projectId: "draw-f2d10",
    storageBucket: "draw-f2d10.appspot.com",
    messagingSenderId: "177556350348",
    appId: "1:177556350348:web:d8b35cdc76f7b68fa3e2a9"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const urlParams = new URLSearchParams(window.location.search);
  const roomId = urlParams.get("roomId");
  if (!roomId) {
    alert("ë°© IDê°€ ì—†ìŠµë‹ˆë‹¤.");
    location.href = "index.html";
  }

  let localUid = null;
  let localStream = null;
  let micOn = false;
  let camOn = false;
  let sharingScreen = false;
  let userName = "";

  const videoContainer = document.getElementById("videoContainer");
  const btnMic = document.getElementById("toggleMic");
  const btnCam = document.getElementById("toggleCam");
  const btnScreen = document.getElementById("shareScreen");

const isHost = urlParams.get("host") === "true"; // URLì—ì„œ host=true ì¸ ê²½ìš° í˜¸ìŠ¤íŠ¸ë¡œ ê°„ì£¼


const bigScreenContainer = document.getElementById("bigScreenContainer");
const bigScreenVideo = document.getElementById("bigScreenVideo");
const expandBtn = document.getElementById("expandBigScreenBtn");

expandBtn.onclick = () => {
  if (!document.fullscreenElement) {
    bigScreenContainer.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
};

bigScreenContainer.onclick = () => {
  const confirmClose = confirm("ê³µìœ ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
  if (!confirmClose) return;

  // ê³µìœ  ì¤‘ì´ë¼ë©´ ì¤‘ë‹¨
  if (sharingScreen) stopScreenShare();

  // ì¹´ë©”ë¼ ê³µìœ ë„ ì¤‘ë‹¨
  bigScreenVideo.srcObject = null;
};


function renderUsers(users, isHost) {
  videoContainer.innerHTML = "";
  for (const uid in users) {
    const user = users[uid];
    const userBox = document.createElement("div");
    userBox.className = "userBox";
    if (user.isHost) userBox.classList.add("host");

    // ì´ë¦„
    const nameDiv = document.createElement("div");
    nameDiv.className = "userName";
    nameDiv.textContent = user.name + (uid === localUid ? " (ë‚˜)" : "") + (user.isHost ? " [í˜¸ìŠ¤íŠ¸]" : "");
    userBox.appendChild(nameDiv);

    // ë¹„ë””ì˜¤
    const videoEl = document.createElement("video");
    videoEl.autoplay = true;
    videoEl.muted = (uid === localUid);
    videoEl.playsInline = true;
    videoEl.style.background = "#000";
    videoEl.style.width = "120px";
    videoEl.style.height = "90px";
    userBox.appendChild(videoEl);

    // í˜¸ìŠ¤íŠ¸ë§Œ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ (ë‹¤ë¥¸ ì‚¬ìš©ì ë¹„ë””ì˜¤ ì„ íƒ)
    if (isHost && uid !== localUid) {
      userBox.style.cursor = "pointer";
userBox.onclick = () => {
  const confirmReplace = confirm("í˜„ì¬ ê³µìœ  ì¤‘ì¸ í™”ë©´ì´ ìˆë‹¤ë©´ ì¤‘ì§€ë©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?");
  if (!confirmReplace) return;

  stopScreenShare(); // ê³µìœ  ì¤‘ì´ë©´ ì¢…ë£Œ
  const stream = getUserVideoStream(uid); // ìœ ì € ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼
  if (stream) {
    bigScreenVideo.srcObject = stream;
  } else {
    alert("í•´ë‹¹ ì‚¬ìš©ìì˜ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
  }
};


    }

    videoContainer.appendChild(userBox);
  }
}



  // ë¡œê·¸ì¸ ë° ë‹‰ë„¤ì„ ì…ë ¥
  
  // ì‚¬ìš©ì ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜
  function renderUsers(users, isHost) {
    videoContainer.innerHTML = "";
    for (const uid in users) {
      const user = users[uid];
      const userBox = document.createElement("div");
      userBox.className = "userBox";
      if (user.isHost) userBox.classList.add("host");

      // ì´ë¦„ í‘œì‹œ
      const nameDiv = document.createElement("div");
      nameDiv.className = "userName";
      nameDiv.textContent = user.name + (uid === localUid ? " (ë‚˜)" : "") + (user.isHost ? " [í˜¸ìŠ¤íŠ¸]" : "");
      userBox.appendChild(nameDiv);

      // TODO: ì‹¤ì œ ì˜ìƒ ì—°ê²° ìœ„ì¹˜ (WebRTC í•„ìš”)
      const videoEl = document.createElement("video");
      videoEl.autoplay = true;
      videoEl.muted = (uid === localUid); // ë‚´ ì˜ìƒì€ ìŒì†Œê±°
      videoEl.playsInline = true;
      videoEl.style.background = "#000";
      videoEl.style.width = "120px";
      videoEl.style.height = "90px";
      userBox.appendChild(videoEl);

      // ìƒíƒœ í‘œì‹œ ë° í˜¸ìŠ¤íŠ¸ìš© ê´€ë¦¬ ë²„íŠ¼
      const controlsDiv = document.createElement("div");
      controlsDiv.className = "controls";

      const micStatus = document.createElement("span");
      micStatus.textContent = user.mic ? "ğŸ¤" : "ğŸ”‡";
      controlsDiv.appendChild(micStatus);

      const camStatus = document.createElement("span");
      camStatus.textContent = user.cam ? "ğŸ“·" : "ğŸ“´";
      camStatus.style.marginLeft = "8px";
      controlsDiv.appendChild(camStatus);

      const screenStatus = document.createElement("span");
      screenStatus.textContent = user.screenSharing ? "ğŸ–¥ï¸" : "";
      screenStatus.style.marginLeft = "8px";
      controlsDiv.appendChild(screenStatus);

      // í˜¸ìŠ¤íŠ¸ë§Œ ë‹¤ë¥¸ ì‚¬ìš©ì ì œì–´ ê°€ëŠ¥ (ìŒì†Œê±°/ê°•í‡´)
      if (isHost && uid !== localUid) {
        const muteBtn = document.createElement("button");
        muteBtn.className = "controlBtn";
        muteBtn.textContent = "ìŒì†Œê±°";
        muteBtn.onclick = () => {
          db.ref(`rooms/${roomId}/users/${uid}`).update({ mic: false });
        };
        controlsDiv.appendChild(muteBtn);

        const kickBtn = document.createElement("button");
        kickBtn.className = "controlBtn";
        kickBtn.textContent = "ê°•í‡´";
        kickBtn.onclick = () => {
          db.ref(`rooms/${roomId}/users/${uid}`).remove();
          alert(`${user.name}ë‹˜ì„ ê°•í‡´í–ˆìŠµë‹ˆë‹¤.`);
        };
        controlsDiv.appendChild(kickBtn);
      }

      userBox.appendChild(controlsDiv);
      videoContainer.appendChild(userBox);
    }
  }
  // ì±„íŒ… ë¡œì§
let ttsMode = false;

document.getElementById("toggleMode").onclick = () => {
  ttsMode = !ttsMode;
  document.getElementById("toggleMode").textContent = ttsMode ? "ğŸ”Š ìŒì„±" : "ğŸ’¬ í…ìŠ¤íŠ¸";
};

// ğŸ‘‡ ì±„íŒ… ë³´ë‚´ê¸° ì²˜ë¦¬
document.getElementById("sendMessage").onclick = sendMessage;
document.getElementById("chatInput").addEventListener("keydown", e => {
  if (e.key === "Enter") sendMessage();
});

function sendMessage() {
  const msg = document.getElementById("chatInput").value.trim();
  if (!msg) return;
  const chatRef = db.ref(`rooms/${roomId}/chats`);
  chatRef.push({
    sender: userName,
    message: msg,
    timestamp: Date.now()
  });
  document.getElementById("chatInput").value = "";
}

// ğŸ‘‡ ìˆ˜ì‹  ì²˜ë¦¬
db.ref(`rooms/${roomId}/chats`).on("child_added", snapshot => {
  const { sender, message } = snapshot.val();
  const msgDiv = document.createElement("div");
  msgDiv.innerText = `${sender}: ${message}`;
  const chatMessages = document.getElementById("chatMessages");
  chatMessages.appendChild(msgDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  if (ttsMode && sender !== userName) {
    const utter = new SpeechSynthesisUtterance(message);
    utter.lang = "ko-KR";
    window.speechSynthesis.speak(utter);
  }
});

// ìˆ˜ì‹  ì²˜ë¦¬


  // ë¡œì»¬ ë¯¸ë””ì–´ ì´ˆê¸°í™”
  async function initLocalMedia() {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
      micOn = true;
      camOn = false;
      updateLocalStream();
      updateUI();
    } catch (e) {
      alert("ë§ˆì´í¬ ê¶Œí•œ í•„ìš”: " + e.message);
    }
  }

  function updateLocalStream() {
    if (!localStream) return;
    localStream.getAudioTracks().forEach(t => t.enabled = micOn);
    localStream.getVideoTracks().forEach(t => t.enabled = camOn);
    updateUserState();
  }

  function updateUserState() {
    if (!localUid) return;
    db.ref(`rooms/${roomId}/users/${localUid}`).update({
      mic: micOn,
      cam: camOn,
      screenSharing: sharingScreen
    });
  }

  function updateUI() {
    btnMic.textContent = micOn ? "ğŸ”‡ ë§ˆì´í¬ ë„ê¸°" : "ğŸ¤ ë§ˆì´í¬ ì¼œê¸°";
    btnCam.textContent = camOn ? "ğŸ“´ ì¹´ë©”ë¼ ë„ê¸°" : "ğŸ“· ì¹´ë©”ë¼ ì¼œê¸°";
    btnScreen.textContent = sharingScreen ? "ğŸ›‘ í™”ë©´ ê³µìœ  ì¤‘ì§€" : "ğŸ–¥ï¸ í™”ë©´ ê³µìœ ";
  }

  // ë²„íŠ¼ ì´ë²¤íŠ¸
  btnMic.onclick = () => {
    micOn = !micOn;
    updateLocalStream();
    updateUI();
  };

  btnCam.onclick = async () => {
    if (sharingScreen) {
      alert("í™”ë©´ ê³µìœ  ì¤‘ì—ëŠ” ì¹´ë©”ë¼ë¥¼ ì¼¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    try {
      if (!camOn) {
        const videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
        videoStream.getVideoTracks().forEach(t => {
          if (!localStream) localStream = new MediaStream();
          localStream.addTrack(t);
        });
        camOn = true;
      } else {
        localStream.getVideoTracks().forEach(t => {
          t.stop();
          localStream.removeTrack(t);
        });
        camOn = false;
      }
      updateLocalStream();
      updateUI();
    } catch(e) {
      alert("ì¹´ë©”ë¼ ê¶Œí•œ í•„ìš” ë˜ëŠ” ì˜¤ë¥˜: " + e.message);
    }
  };

  btnScreen.onclick = async () => {
    if (sharingScreen) {
      stopScreenShare();
    } else {
      startScreenShare();
    }
    updateUI();
  };

async function startScreenShare() {
  try {
    const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
    sharingScreen = true;

    bigScreenVideo.srcObject = stream; // âœ… í° ìŠ¤í¬ë¦°ì— ê³µìœ  í‘œì‹œ

    updateUserState();
    updateUI();

    stream.getVideoTracks()[0].onended = () => stopScreenShare();
  } catch (e) {
    alert("í™”ë©´ ê³µìœ  ì‹¤íŒ¨: " + e.message);
    sharingScreen = false;
    updateUserState();
    updateUI();
  }
}

  function stopScreenShare() {
    sharingScreen = false;
    // í™”ë©´ ê³µìœ  íŠ¸ë™ ì¢…ë£Œ ë° ì œê±° (ìƒëµ)

    updateUserState();
    updateUI();
  }




const btnDeleteRoom = document.getElementById("deleteRoomBtn");
const hostControls = document.getElementById("hostControls");

async function loginAndInit() {
  try {
    const userCredential = await firebase.auth().signInAnonymously();
    localUid = userCredential.user.uid;

    const nickname = prompt("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”") || "ìµëª…";
    userName = nickname;

    // âœ… ë°© ì¢…ë£Œ ì—¬ë¶€ í™•ì¸
    const closedSnap = await db.ref(`rooms/${roomId}/closed`).get();
    if (closedSnap.exists()) {
      alert("ì´ ë°©ì€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.href = "index.html";
      return;
    }

    // âœ… ì‚¬ìš©ì ìˆ˜ ì²´í¬
    const usersSnap = await db.ref(`rooms/${roomId}/users`).get();  // â† ì—¬ê¸°ì— ì˜®ê¹€
    const users = usersSnap.val() || {};
    const userCount = Object.keys(users).length;
    if (userCount >= 5) {
      alert("ìµœëŒ€ ì¸ì› 5ëª…ì…ë‹ˆë‹¤. ì…ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      location.href = "index.html";
      return;
    }

    // í•¨ìˆ˜ í˜¸ì¶œ

    // âœ… í˜¸ìŠ¤íŠ¸ì´ë©´ ë°© ì‚­ì œ ë²„íŠ¼ ë³´ì´ê²Œ
    if (isHost) {
      document.getElementById("hostControls").style.display = "block";
// ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ
document.getElementById("deleteRoomBtn").onclick = async () => {
  const confirmDelete = confirm("ì •ë§ë¡œ ë°©ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
  if (!confirmDelete) return;

  // ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ì¢…ë£Œ ì•Œë¦¼
  await db.ref(`rooms/${roomId}/closed`).set(true);

  // ë°”ë¡œ ë°© ë°ì´í„° ì‚­ì œ (setTimeout ì œê±°)
  await db.ref(`rooms/${roomId}`).remove();

  alert("ë°©ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
  location.href = "index.html";
};
    }

    // âœ… ì‚¬ìš©ì ë“±ë¡
    const userRef = db.ref(`rooms/${roomId}/users/${localUid}`);
    await userRef.set({
      name: nickname,
      mic: false,
      cam: false,
      screenSharing: false,
      isHost: isHost,
      active: true
    });
    userRef.onDisconnect().remove();

    // âœ… ì‚¬ìš©ì ëª©ë¡ ë Œë”ë§
    db.ref(`rooms/${roomId}/users`).on("value", snapshot => {
      const users = snapshot.val() || {};
      renderUsers(users, isHost);
    });

    // âœ… ë°© ì¢…ë£Œ ê°ì§€ â†’ ëª¨ë‘ index.html ì´ë™
    db.ref(`rooms/${roomId}/closed`).on("value", snapshot => {
      if (snapshot.exists()) {
        alert("ë°©ì´ ì¢…ë£Œë˜ì–´ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
        location.href = "index.html";
      }
    });

    await initLocalMedia();
  } catch (e) {
    alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + e.message);
  }
}

  loginAndInit();



</script>

</body>
</html>
